(function(e,t){typeof module!="undefined"&&module.exports?module.exports=t():typeof define=="function"&&define.amd?define("../core/core",t):e.GAME.core=t(e.GAME||{})})(this,function(e){Array.prototype.clean=function(e){for(var t=0;t<this.length;t++)this[t]==e&&(this.splice(t,1),t--);return this};var t=function(e,t,n){var r=Number(e),i=Number(t),s=Number(n),o;return s=Math.max(0,Math.min(1,s)),o=r+s*(i-r),o},n=function(e,t){return{dx:e,dy:t}},r=function(e){var t=0,n=0,r=Object.keys(e),i=r.length,s;for(var o=0;o<i;o++){s=r[o];if(e[s])switch(s){case"up":n++;break;case"down":n--;break;case"right":t++;break;case"left":t--}}return this.getVector(t,n)},i=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},s=function(){this.offset=100,this.buffersize=120,this.smoothing=20},o=function(e,t){return e.x<=t.x+t.width&&t.x<=e.x+e.width&&e.y<=t.y+t.height&&t.y<=e.y+e.height},u=function(e){};return{lerp:t,getVector:n,getVelocity:r,getRandomNumber:i,initGlobalVariables:s,isCollision:o,loadScene:u}}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t():typeof define=="function"&&define.amd?define("input",t):e.GAME.input=t(e.GAME||{})}(this,function(e){var t={},n={32:"spacebar",37:"left",39:"right",65:"left",68:"right"},r=function(e){var r=e.keyCode;n[r]&&(e.preventDefault(),t[n[r]]=e.type==="keydown"?!0:!1)},i=function(){window.addEventListener("keyup",r),window.addEventListener("keydown",r)};return{init:i,pressed:t}}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t():typeof define=="function"&&define.amd?define("../core/time",t):e.GAME.time=t(e.GAME||{})}(this,function(e){var t=Date.now(),n=function(){this.now=Date.now(),this.delta=(this.now-this.then)/1e3,this.then=this.now};return{then:t,setDelta:n}}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t():typeof define=="function"&&define.amd?define("../core/types/Entity",t):(e.GAME=e.GAME||{},e.GAME.Entity=t(e.GAME||{}))}(this,function(e){var t=function(e){this.state={},e&&this.set(e)};return t.prototype.set=function(e){for(var t in e)this[t]=e[t];this.color=this.color||"black",this.rotation=this.rotation||0,this.scale=this.scale||1},t.prototype.draw=function(e){e.ctx.save();var t=this.x+.5|0,n=this.y+.5|0;e.ctx.translate(t+this.width/2,n+this.height/2),e.ctx.rotate(this.rotation),e.ctx.scale(this.scale,this.scale),e.ctx.translate(-this.width/2,-this.height/2),this.drawType&&this.drawType(e),e.ctx.restore()},t}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t(require("./Entity")):typeof define=="function"&&define.amd?define("../core/types/Rectangle",["./Entity"],t):(e.GAME=e.GAME||{},e.GAME.Rectangle=t(e.GAME||{}))}(this,function(e){var t=function(e){e&&this.set(e)};return t.prototype=new e,t.prototype.drawType=function(e){e.ctx.fillStyle=this.color,e.ctx.fillRect(0,0,this.width,this.height),e.ctx.fill()},t}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t(require("../core.js"),require("../time.js"),require("./Rectangle"),require("node-uuid")):typeof define=="function"&&define.amd?define("../core/types/Missile",["../core","../time","./Rectangle"],t):(e.GAME=e.GAME||{},e.GAME.Missile=t(e.GAME||{}))}(this,function(e,t,n,r){var i=function(e){this.uuid=r?r.v4():!1;var t={speed:300,vy:0,y:0,x:0};this.set(t),this.width=10,this.height=20,this.ship=e,this.queue={},this.queue.server=[]};return i.prototype=new n,i.prototype.explode=function(e,t){var n={};this.vy=0,n.y=this.y,this.reload(e,t),typeof t=="function"&&t(this.uuid,n)},i.prototype.fire=function(e,t){var n={};this.ship&&(this.x=this.ship.x+this.ship.width/2-this.width/2,n.x=this.x,this.y=this.ship.y,n.y=this.y),this.vy=this.speed,n.vy=this.vy,this.isLive=!0,n.isLive=this.isLive,typeof t=="function"&&t(this.uuid,n)},i.prototype.move=function(e,n){var r={};this.y-=this.vy*t.delta,r.y=this.y,this.y<0-this.height&&this.reload(e,n),typeof n=="function"&&n(this.uuid,r)},i.prototype.reload=function(e,t){var n={};this.x=-this.height,n.x=this.x,this.ship&&(this.y=this.ship.y,n.y=this.y),this.isLive=!1,n.isLive=this.isLive,typeof t=="function"&&t(this.uuid,n)},i.prototype.interpolate=function(){var n=Math.abs(this.sy-this.y);if(!this.queue.server.length||n<.1)return;n>150&&(this.y=this.sy);var r,i,s,o,u=this.queue.server.length-1,a,f;for(var l=0;l<u;l++){a=this.queue.server[l],f=this.queue.server[l+1];if(t.client>a.time&&t.client<f.time){s=a,o=f;break}}s||(s=o=this.queue.server[this.queue.server.length-1]);var c=0;if(s.time!==o.time){var n=s.time-t.client,h=s.time-o.time;c=n/h}r=e.lerp(o.state.y,s.state.y,c),this.y=e.lerp(this.y,r,t.delta*e.smoothing),this.y<0-this.height&&this.reload()},i.prototype.getState=function(){return{uuid:this.uuid,state:{y:this.y,x:this.x,isLive:this.isLive}}},i}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t():typeof define=="function"&&define.amd?define("../client/input",t):e.GAME.input=t(e.GAME||{})}(this,function(e){var t={},n={32:"spacebar",37:"left",39:"right",65:"left",68:"right"},r=function(e){var r=e.keyCode;n[r]&&(e.preventDefault(),t[n[r]]=e.type==="keydown"?!0:!1)},i=function(){window.addEventListener("keyup",r),window.addEventListener("keydown",r)};return{init:i,pressed:t}}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t(require("./Entity")):typeof define=="function"&&define.amd?define("../core/types/Image",["./Entity"],t):(e.GAME=e.GAME||{},e.GAME.Enemy=t(e.GAME||{}))}(this,function(e){var t=function(e){var t={x:0,y:0};this.set(t),this.load(e)};return t.prototype=new e,t.prototype.load=function(e){var t=this;t.ready=!1,t.image=new window.Image,t.image.src=e,t.image.onload=function(){t.ready=!0}},t.prototype.drawType=function(e){this.ready&&e.ctx.drawImage(this.image,0,0)},t}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t(require("../core"),require("../time"),require("../../client/input"),require("./Entity"),require("./Missile"),undefined,require("node-uuid")):typeof define=="function"&&define.amd?define("../core/types/Ship",["../core","../time","../../client/input","./Entity","./Missile","./Image"],t):(e.GAME=e.GAME||{},e.GAME.Ship=t(e.GAME||{}))}(this,function(e,t,n,r,i,s,o){var u=function(e){this.uuid=o?o.v4():!1,this.set(e),this.setDefaults(),this.loadMissiles(),this.queue={},this.queue.server=[],this.server={}};return u.prototype=new r,u.prototype.setDefaults=function(){this.fireButtonReleased=!0,this.image=s?new s("images/ship.png"):!1,this.missiles=[],this.now=0,this.then=0,this.height=50,this.width=50;var e={x:20,y:380,vx:0,speed:this.speed||300,maxMissiles:this.maxMissiles||3,repeatRate:this.repeatRate||30};this.set(e)},u.prototype.respondToInput=function(n,r){var i=e.getVelocity(r),s=!1,o;this.vx=parseInt(this.speed*t.delta*i.dx),r.spacebar?this.fire():(this.fireButtonReleased||(s=!0),this.fireButtonReleased=!0);if(this.vx||r.spacebar||s)o={time:Date.now(),seq:n.seq++,input:r,data:{speed:this.speed,vector:i}},n.queue.input.push(o),n.socket.emit("command:send",o)},u.prototype.move=function(){this.sx?(this.sx+=this.vx,this.queue.server.push(this),this.queue.server.length>=e.buffersize&&this.queue.server.splice(0,this.queue.server.length-e.buffersize)):this.x+=this.vx},u.prototype.reconcile=function(e,n){var r=0,i=0,s=e.queue.input=e.queue.input.filter(function(e,n,r){return e.seq==this.ack&&(t.latency=(Date.now()-e.time)/1e3),e.seq>this.ack}.bind(this));for(var o=0;o<s.length;o++)r+=parseInt(s[o].data.speed*s[o].data.vector.dx*t.delta);this.sx=parseInt(n.ship.state.x)+r},u.prototype.interpolate=function(){var n=Math.abs(this.sx-this.x);if(!this.queue.server.length)return;if(n<.1||n>200){this.x=this.sx;return}var r,i,s,o,u=this.queue.server.length-1,a,f;for(var l=0;l<u;l++){a=this.queue.server[l],f=this.queue.server[l+1];if(t.client>a.time&&t.client<f.time){s=a,o=f;break}}s||(s=o=this.queue.server[this.queue.server.length-1]);var c=0;if(s.time!==o.time){var n=s.time-t.client,h=s.time-o.time;c=n/h}r=e.lerp(o.sx,s.sx,c),this.x=e.lerp(this.x,r,t.delta*e.smoothing)},u.prototype.loadMissiles=function(){var e=0;while(e<this.maxMissiles)this.missiles.push(new i(this)),e++},u.prototype.fire=function(e,n){this.now=t.now;var r=(this.now-this.then)/1e3,i=Object.keys(this.missiles),s=i.length,o,u=[],a;for(var f=0;f<s;f++)o=i[f],a=this.missiles[o],a.isLive||u.push(a);var l=u.length>0,c=r>1/this.repeatRate,h=c&&l&&this.fireButtonReleased;h&&(this.fireButtonReleased=!1,u[0].fire(e,n),this.then=this.now)},u.prototype.drawType=function(t){e.debug&&(t.ctx.fillStyle="rgba(0, 0, 255, 0.25)",t.ctx.fillRect(0,0,this.width,this.height),t.ctx.fill()),this.image.draw(t)},u.prototype.die=function(){console.log("die!")},u.prototype.getState=function(){var e=[];for(var t=0;t<this.missiles.length;t++)e.push(this.missiles[t].getState());return{uuid:this.uuid,state:this.state,missiles:e}},u}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t(require("../core"),require("./Entity"),require("./Missile"),require("./Ship")):typeof define=="function"&&define.amd?define("../core/types/Player",["../core","./Entity","./Missile","./Ship"],t):(e.GAME=e.GAME||{},e.GAME.Player=t(e.GAME||{}))}(this,function(e,t,n,r){var i=function(e){this.ship=new r;if(e){var t=Object.keys(e.ship.state),i=t.length,s;for(var o=0;o<i;o++)s=t[o],this.ship[s]=parseInt(e.ship.state[s]);this.ship.missiles={};var u;for(var a=0;a<e.ship.missiles.length;a++)u=e.ship.missiles[a],this.ship.missiles[u.uuid]=new n}return this.queue=[],this.processed=[],this};return i.prototype=new t,i.prototype.getState=function(){return{state:this.state,ship:this.ship.getState()}},i}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t(require("../core"),require("../time"),require("./Entity"),undefined,require("node-uuid")):typeof define=="function"&&define.amd?define("../core/types/Enemy",["../core","../time","./Entity","./Image"],t):(e.GAME=e.GAME||{},e.GAME.Enemy=t(e.GAME||{}))}(this,function(e,t,n,r,i){var s=function(t,n,s){this.uuid=i?i.v4():!1;var o={x:t+e.getRandomNumber(-25,25),y:n,speed:100,vx:100,vy:0,direction:s||1};this.set(o),this.y=n,this.width=50,this.height=30,this.color="rgba(0, 0, 255, 0.25)",this.image=r?new r("images/enemy.png"):!1,this.missiles=[],this.maxMissiles=5,this.range=50,this.origin={x:t,y:n},this.queue={},this.queue.server=[]};return s.prototype=new n,s.prototype.destroy=function(){this.isHit=!0,this.vy=-200},s.prototype.drawType=function(t){e.debug&&(this.isDestroyed&&(this.color="red"),t.ctx.fillStyle=this.color,t.ctx.fillRect(0,0,this.width,this.height),t.ctx.fill()),this.image.draw(t)},s.prototype.move=function(e,n){var r={};this.x+=this.vx*this.direction*t.delta,r.x=this.x,this.isHit?(this.y+=this.vy*t.delta,r.y=this.y,this.rotation+=20*t.delta,r.rotation=this.rotation,this.isDestroyed=this.y<-Math.max(this.height,this.width),r.isDestroyed=this.isDestroyed):(this.x>this.origin.x+this.range?this.direction=-1:this.x<this.origin.x-this.range&&(this.direction=1),r.direction=this.direction),typeof n=="function"&&n(this.uuid,r)},s.prototype.interpolate=function(){var n=Math.abs(this.sx-this.x),r=Math.abs(this.sy-this.y),i=Math.max(n,r);if(!this.queue.server.length||i<.1)return;if(i>200){console.log(i),this.x=this.sx,this.y=this.sy;return}var s,o,u,a,f=this.queue.server.length-1,l,c;for(var h=0;h<f;h++){l=this.queue.server[h],c=this.queue.server[h+1];if(t.client>l.time&&t.client<c.time){u=l,a=c;break}}u||(u=a=this.queue.server[this.queue.server.length-1]);var p=0;if(u.time!==a.time){var i=u.time-t.client,d=u.time-a.time;p=i/d}a.x&&u.x&&(s=e.lerp(a.x,u.x,p),this.x=e.lerp(this.x,s,t.delta*e.smoothing)),a.y&&u.y&&(o=e.lerp(a.y,u.y,p),this.y=e.lerp(this.y,o,t.delta*e.smoothing))},s.prototype.getState=function(){return{uuid:this.uuid,state:{x:this.x,y:this.y,direction:this.direction}}},s}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t():typeof define=="function"&&define.amd?define("client",["../core/core","../core/time","./input","../core/types/Player","../core/types/Enemy"],t):e.GAME.client=t(e.GAME||{})}(this,function(e,t,n,r,i){var s={},o={},u=0,a={};a.input=[],a.server=[];var f=function(n){this.actions=[this.clearCanvas,this.updatePlayers,this.updateNPCs];var s=this.socket=io.connect();s.on("players",function(e){var t=Object.keys(e),i=t.length,o;n.players={};for(var u=0;u<i;u++)o=t[u],n.players[o]=new r(e[o]);s.on("players:add",function(e){n.players[e.uuid]=new r(e.player)}),s.on("players:remove",function(e){delete n.players[e]})}),s.on("npcs",function(e){var t=Object.keys(e),r=t.length,o,u;n.npcs={};for(var a=0;a<r;a++)o=t[a],u=e[o],n.npcs[o]=new i(u.x,u.y,u.direction);s.on("npc:add",function(e){n.npcs[e.uuid]=new i(e.state.x,e.state.y,e.state.direction)}),s.on("npc:destroy",function(e){n.npcs[e].destroy()})}),s.on("uuid",function(r){n.uuid=r,s.on("state:update",function(r){t.server=r.time,t.client=t.server-e.offset;var i=Object.keys(r.players),s=i.length,o,u,a;if(s)for(var f=0;f<s;f++){o=i[f],u=r.players[o],a=n.players[o],u.ack&&(a.ship.ack=u.ack);if(a&&u.ship){u.ship.state&&(u.ship.state.y&&(a.ship.sy=parseInt(u.ship.state.y)),o===n.uuid?a.ship.reconcile(n,u):u.ship.state.x&&(a.ship.sx=parseInt(u.ship.state.x)));if(u.ship.missiles){var l=u.ship.missiles,c=Object.keys(l),h,p,d;for(var v=0;v<c.length;v++)h=c[v],serverMissile=l[h],d=_.find(a.ship.missiles,function(e,t){return t===h}),serverMissile.state.y&&(d.sy=parseInt(serverMissile.state.y)),serverMissile.state.x&&(d.x=parseInt(serverMissile.state.x)),serverMissile.state.isLive&&(d.isLive=serverMissile.state.isLive==="true"),d.queue.server.push(serverMissile)}}}var m=Object.keys(r.npcs),g=m.length,o,y,b;if(g)for(var f=0;f<g;f++)o=m[f],y=r.npcs[o],b=n.npcs[o],b&&(r.ack&&(b.ack=r.ack),b.isHit=y.isHit?!0:!1,b.sx=typeof y.x!="undefined"?parseInt(y.x):b.x,b.sy=typeof y.y!="undefined"?parseInt(y.y):b.y,b.rotation=parseInt(y.rotation),b.queue.server.push(y),b.queue.server.length>=e.buffersize&&b.queue.server.splice(-e.buffersize))})})},l=function(e){e=e||this,e.animationFrame=window.requestAnimationFrame(function(){l(e)}.bind(e)),t.setDelta(),p(e)},c=function(){window.cancelAnimationFrame(this.animationFrame),this.areRunning=!1},h=function(){this.areRunning||(this.then=Date.now(),this.loop(),this.areRunning=!0)},p=function(e){for(var t=0;t<e.actions.length;t++)e.actions[t](e)},d=function(e){e.ctx.clearRect(0,0,e.canvas.width,e.canvas.height)},v=function(e,t){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=e,this.canvas.height=t,document.getElementById("canvas-wrapper").appendChild(this.canvas)},m=function(e){var t=Object.keys(e.players),r=t.length,i,s,o=function(t){var n=Object.keys(t),r=n.length,i,s;for(var o=0;o<r;o++)i=n[o],s=t[i],s.isLive&&(s.interpolate(),s.draw(e))};for(var u=0;u<r;u++)i=t[u],s=e.players[i],i===e.uuid?(s.ship.respondToInput(e,n.pressed),s.ship.move(),s.ship.interpolate()):(s.ship.move(),s.ship.interpolate()),o(s.ship.missiles),s.ship.draw(e)},g=function(e){var t=Object.keys(e.npcs),n=t.length,r,i;for(var s=n;s--;)r=t[s],i=e.npcs[r],i.interpolate(),i.draw(e)};return{players:s,npcs:o,seq:u,queue:a,init:f,loop:l,pause:c,play:h,runFrameActions:p,clearCanvas:d,createCanvas:v,updatePlayers:m,updateNPCs:g}}),function(e,t){typeof module!="undefined"&&module.exports?module.exports=t():typeof define=="function"&&define.amd?define("init",["../core/core","input","client"],t):e.GAME.init=t(e.GAME||{})}(this,function(e,t,n){e.initGlobalVariables(),t.init(),n.createCanvas(800,450),n.init(n),n.play()});